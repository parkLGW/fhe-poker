# 测试指南 - 错误 0x9de3392c 修复

## 修复内容

已修复 ethers.js 在处理加密数据参数时的类型转换问题。现在所有加密数据（`Uint8Array`）在传递给合约前都会显式转换为 hex 字符串。

## 修改的文件

1. `frontend/src/lib/fhevm.ts` - 添加 `uint8ArrayToHex()` 工具函数
2. `frontend/src/services/ContractService.ts` - 修改 `bet()` 和 `joinTable()` 函数
3. `frontend/src/lib/ethers-contract.ts` - 修改 `callBet()` 和 `callJoinTable()` 函数

## 测试步骤

### 1. 清除浏览器缓存

```bash
# 在浏览器中：
# 1. 打开开发者工具 (F12)
# 2. 右键点击刷新按钮，选择"清空缓存并硬性重新加载"
# 或者
# 3. 清除所有 cookies 和缓存数据
```

### 2. 启动前端应用

```bash
cd fhe-poker/frontend
npm run dev
```

### 3. 连接钱包

- 打开应用
- 连接 MetaMask 钱包
- 确保连接到 Sepolia 测试网络

### 4. 测试下注功能

#### 步骤 A：创建游戏桌

1. 进入大厅页面
2. 点击"创建游戏桌"
3. 设置小盲注和大盲注
4. 确认创建

#### 步骤 B：加入游戏

1. 选择刚创建的游戏桌
2. 输入买入金额（例如：1000）
3. 点击"加入游戏"
4. **检查浏览器控制台日志**：
   - 应该看到 `🔄 参数转换为 hex:` 日志
   - 确认 `encryptedBuyInHex` 和 `inputProofHex` 已生成

#### 步骤 C：开始游戏

1. 等待其他玩家加入（或者只有你一个玩家）
2. 点击"开始游戏"
3. 等待游戏开始

#### 步骤 D：测试下注

1. 当轮到你操作时，输入下注金额（例如：100）
2. 点击"加注"按钮
3. **关键检查**：
   - 浏览器控制台应该显示：
     ```
     🔐 开始加密下注金额...
     🔐 已加密下注金额: {encryptedAmount: Uint8Array(32), inputProof: Uint8Array(100)}
     📝 下注参数: {...}
     🔄 参数转换为 hex:
       - encryptedAmountHex: 0x...
       - inputProofHex: 0x...
     📞 调用合约 bet 函数...
     ✅ 交易已发送: 0x...
     ✅ 下注成功，交易确认: 0x...
     ```
   - 交易应该成功完成
   - 不应该出现 `0x9de3392c` 错误

## 预期结果

✅ **成功**：
- 下注交易成功发送和确认
- 游戏状态正确更新
- 没有 `InvalidEncryptedAmount` 错误

❌ **失败**：
- 仍然出现 `0x9de3392c` 错误
- 交易被拒绝
- 控制台显示其他错误

## 调试信息

如果测试失败，请检查以下信息：

### 1. 浏览器控制台日志

打开浏览器开发者工具 (F12)，查看 Console 标签：

- 搜索 `🔄 参数转换为 hex:` - 确认参数已转换
- 搜索 `❌` - 查看是否有错误信息
- 搜索 `0x9de3392c` - 确认是否仍然出现此错误

### 2. 网络请求

在 Network 标签中：
- 查看交易是否已发送
- 检查交易的返回数据

### 3. 合约地址

确认前端使用的合约地址与部署的地址一致：
- 前端地址：`0x0699b2fFc94782D66808a472872ED8319e92A60d`
- 部署地址：检查 `deployments/sepolia/PokerTable.json`

## 常见问题

### Q: 仍然出现 0x9de3392c 错误

**A:** 
1. 清除浏览器缓存并重新加载
2. 检查合约地址是否正确
3. 确保使用的是最新的前端代码

### Q: 交易被拒绝

**A:**
1. 检查钱包余额是否足够
2. 确保连接到正确的网络（Sepolia）
3. 检查合约是否已正确部署

### Q: 看不到日志

**A:**
1. 打开浏览器开发者工具 (F12)
2. 切换到 Console 标签
3. 确保没有过滤日志

## 成功标志

修复成功的标志：
- ✅ 下注交易成功完成
- ✅ 游戏状态正确更新
- ✅ 没有 `0x9de3392c` 错误
- ✅ 浏览器控制台显示正确的 hex 转换日志

## 后续步骤

如果测试成功，可以：
1. 测试其他游戏功能（fold、check、call 等）
2. 进行多玩家游戏测试
3. 测试游戏结束和奖励分配

