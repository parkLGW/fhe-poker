# 加注失败问题 - 修复总结

## 🎯 问题

用户点击"加注"按钮时失败，错误信息：
```
Error: execution reverted (unknown custom error)
error selector: 0x9de3392c
```

## 🔍 根本原因

**地址格式不一致导致 FHEVM 验证失败**

### 问题所在

在 `frontend/src/hooks/useFHEVM.ts` 中：

```typescript
// ❌ 错误的做法
const contractAddr = POKER_TABLE_ADDRESS.toLowerCase();  // 转小写
const userAddr = address.toLowerCase();                   // 转小写
return encryptUint64(amount, contractAddr, userAddr);
```

然后在 `frontend/src/lib/fhevm.ts` 中：

```typescript
// ❌ 再转一次
const checksumContractAddr = getAddress(contractAddress);  // 再转校验和
const checksumUserAddr = getAddress(userAddress);          // 再转校验和
```

**结果**：地址被转换了两次，导致加密时使用的地址与合约验证时的地址不一致。

## ✅ 修复方案

### 修改文件

`frontend/src/hooks/useFHEVM.ts`

### 修改内容

#### 1. `encryptBuyIn()` 函数

```typescript
// ❌ 修改前
const contractAddr = POKER_TABLE_ADDRESS.toLowerCase();
const userAddr = address.toLowerCase();
return encryptUint64(amount, contractAddr, userAddr);

// ✅ 修改后
return encryptUint64(amount, POKER_TABLE_ADDRESS, address);
```

#### 2. `encryptBetAmount()` 函数

```typescript
// ❌ 修改前
const contractAddr = POKER_TABLE_ADDRESS.toLowerCase();
const userAddr = address.toLowerCase();
return encryptUint64(amount, contractAddr, userAddr);

// ✅ 修改后
return encryptUint64(amount, POKER_TABLE_ADDRESS, address);
```

#### 3. `encryptCard()` 函数

```typescript
// ❌ 修改前
const contractAddr = POKER_TABLE_ADDRESS.toLowerCase();
const userAddr = address.toLowerCase();
return encryptUint8(cardValue, contractAddr, userAddr);

// ✅ 修改后
return encryptUint8(cardValue, POKER_TABLE_ADDRESS, address);
```

## 🔑 为什么这样修复有效

1. **地址一致性** - 确保加密时和验证时使用相同的地址
2. **单一转换点** - 只在 `encryptUint64` 中进行一次转换
3. **符合官方示例** - 与 Zama dev.md 中的代码完全一致

## 📚 官方文档支持

Zama 官方 dev.md 第 1344-1347 行的示例：

```typescript
const encryptedOne = await fhevm
  .createEncryptedInput(fheCounterContractAddress, signers.alice.address)
  .add32(clearOne)
  .encrypt();
```

**关键点**：直接传递原始地址，让库内部处理格式转换。

## 🧪 测试步骤

1. **清除浏览器缓存**
   - Chrome: Ctrl+Shift+Delete (Windows) 或 Cmd+Shift+Delete (Mac)
   - 或在开发者工具中清除 Application > Cache Storage

2. **重启前端服务**
   ```bash
   cd frontend
   npm run dev
   ```

3. **测试游戏流程**
   - 访问 `http://localhost:5173/`
   - 连接钱包
   - 创建或加入游戏
   - 点击"开始游戏"
   - 轮到你时，点击"加注"
   - 输入金额

## ✨ 预期结果

```
✅ 加注成功
✅ 游戏状态更新
✅ 轮到下一个玩家
```

## 📊 修复影响范围

| 功能 | 状态 |
|------|------|
| 买入游戏 | ✅ 修复 |
| 下注/加注 | ✅ 修复 |
| 出牌 | ✅ 修复 |
| 其他加密操作 | ✅ 修复 |

## 📝 相关文档

- `ROOT_CAUSE_ANALYSIS.md` - 详细的根本原因分析
- `BEFORE_AFTER_FIX.md` - 修复前后对比
- `FHEVM_ADDRESS_FIX.md` - 地址格式修复详解
- `INVESTIGATION_COMPLETE.md` - 完整的调查报告

## 🎓 学到的教训

1. **FHEVM 对地址格式敏感** - 必须保持一致
2. **避免多次转换** - 在一个地方统一处理
3. **参考官方示例** - 官方文档是最佳实践
4. **理解加密验证** - 了解 `inputProof` 的作用很重要

## 🚀 下一步

1. 测试所有游戏功能
2. 验证其他加密操作
3. 检查是否还有其他地址格式问题
4. 更新代码注释

---

**修复完成！** 现在可以测试加注功能了。

