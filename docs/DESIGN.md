# ğŸ® FHE Poker åˆçº¦è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

FHE Poker æ˜¯ä¸€ä¸ªåŸºäºå…¨åŒæ€åŠ å¯†(FHE)çš„é“¾ä¸Šå¾·å·æ‰‘å…‹æ¸¸æˆï¼Œé€šè¿‡FHEVMæŠ€æœ¯å®ç°æ‰‹ç‰Œå®Œå…¨éšç§ä¿æŠ¤ã€‚

## 2. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 2.1 éšç§ä¿æŠ¤
- **æ‰‹ç‰ŒåŠ å¯†**: ä½¿ç”¨ `euint8` ç±»å‹å­˜å‚¨æ¯å¼ ç‰Œ(0-51)
- **ä½™é¢åŠ å¯†**: ä½¿ç”¨ `euint64` ç±»å‹å­˜å‚¨ç©å®¶ç­¹ç 
- **ACLæ§åˆ¶**: ç©å®¶åªèƒ½è®¿é—®è‡ªå·±çš„æ‰‹ç‰Œ
- **å…¬å…±ç‰Œæ˜æ–‡**: å…¬å…±ç‰Œå¯¹æ‰€æœ‰äººå¯è§,ä½¿ç”¨ `uint8` å­˜å‚¨

### 2.2 å…¬å¹³æ€§ä¿è¯
- **é“¾ä¸Šéšæœºæ•°**: ä½¿ç”¨ `FHE.randEuint8()` ç”Ÿæˆéšæœºç‰Œ
- **é˜²æ­¢ä½œå¼Š**: æ‰‹ç‰Œåœ¨å‘ç‰Œæ—¶å³åŠ å¯†,æ— æ³•æå‰çŸ¥é“
- **å¼‚æ­¥è§£å¯†**: æ‘Šç‰Œæ—¶é€šè¿‡Oracleå®‰å…¨è§£å¯†

## 3. æ•°æ®ç»“æ„è®¾è®¡

### 3.1 æ‰‘å…‹ç‰Œè¡¨ç¤º

```
ç‰Œå€¼ç¼–ç : 0-51
- 0-12:   é»‘æ¡ƒ A,2,3,4,5,6,7,8,9,10,J,Q,K
- 13-25:  çº¢å¿ƒ A,2,3,4,5,6,7,8,9,10,J,Q,K
- 26-38:  æ–¹å— A,2,3,4,5,6,7,8,9,10,J,Q,K
- 39-51:  æ¢…èŠ± A,2,3,4,5,6,7,8,9,10,J,Q,K

èŠ±è‰²æå–: suit = cardValue / 13
ç‚¹æ•°æå–: rank = cardValue % 13
```

### 3.2 ç©å®¶ç»“æ„ (Player)

```solidity
struct Player {
    address addr;           // ç©å®¶åœ°å€
    euint64 balance;        // åŠ å¯†ä½™é¢ âœ…
    euint8 card1;           // åŠ å¯†æ‰‹ç‰Œ1 âœ…
    euint8 card2;           // åŠ å¯†æ‰‹ç‰Œ2 âœ…
    bool hasFolded;         // æ˜¯å¦å¼ƒç‰Œ
    bool isActive;          // æ˜¯å¦æ´»è·ƒ
    euint64 currentBet;     // å½“å‰ä¸‹æ³¨ âœ…
    euint64 totalBet;       // æ€»ä¸‹æ³¨ âœ…
    PlayerAction lastAction;// æœ€ååŠ¨ä½œ
    uint256 lastActionTime; // åŠ¨ä½œæ—¶é—´
}
```

### 3.3 æ¸¸æˆæ¡Œç»“æ„ (Table)

```solidity
struct Table {
    uint256 tableId;                    // æ¡Œå·
    GameState state;                    // æ¸¸æˆçŠ¶æ€
    Player[6] players;                  // ç©å®¶æ•°ç»„
    uint8 playerCount;                  // ç©å®¶æ•°
    uint8 activePlayers;                // æ´»è·ƒç©å®¶æ•°
    uint8[5] communityCards;            // å…¬å…±ç‰Œ(æ˜æ–‡)
    uint8 communityCardCount;           // å…¬å…±ç‰Œæ•°é‡
    euint64 pot;                        // å¥–æ±  âœ…
    euint64 currentBet;                 // å½“å‰æœ€é«˜æ³¨ âœ…
    uint8 currentPlayerIndex;           // å½“å‰ç©å®¶
    uint8 dealerIndex;                  // åº„å®¶ä½ç½®
    uint8 smallBlindIndex;              // å°ç›²ä½ç½®
    uint8 bigBlindIndex;                // å¤§ç›²ä½ç½®
    uint256 smallBlind;                 // å°ç›²é‡‘é¢
    uint256 bigBlind;                   // å¤§ç›²é‡‘é¢
    uint256 roundStartTime;             // è½®æ¬¡å¼€å§‹æ—¶é—´
    uint256 lastDecryptRequestId;       // è§£å¯†è¯·æ±‚ID
    bool isDecryptionPending;           // ç­‰å¾…è§£å¯†
}
```

## 4. çŠ¶æ€æœºè®¾è®¡

### 4.1 æ¸¸æˆçŠ¶æ€æµè½¬

```
Waiting (ç­‰å¾…ç©å®¶)
    â†“ [ç©å®¶æ•° >= 2]
PreFlop (ç¿»ç‰Œå‰)
    â†“ [å‘2å¼ æ‰‹ç‰Œ + ä¸‹æ³¨å®Œæˆ]
Flop (ç¿»ç‰Œåœˆ)
    â†“ [å‘3å¼ å…¬å…±ç‰Œ + ä¸‹æ³¨å®Œæˆ]
Turn (è½¬ç‰Œåœˆ)
    â†“ [å‘1å¼ å…¬å…±ç‰Œ + ä¸‹æ³¨å®Œæˆ]
River (æ²³ç‰Œåœˆ)
    â†“ [å‘1å¼ å…¬å…±ç‰Œ + ä¸‹æ³¨å®Œæˆ]
Showdown (æ‘Šç‰Œ)
    â†“ [è¯·æ±‚è§£å¯† + æ¯”ç‰Œ]
Finished (ç»“æŸ)
    â†“ [åˆ†é…å¥–æ± ]
Waiting (ç­‰å¾…ä¸‹ä¸€å±€)
```

### 4.2 çŠ¶æ€è½¬æ¢æ¡ä»¶

| å½“å‰çŠ¶æ€ | è§¦å‘æ¡ä»¶ | ä¸‹ä¸€çŠ¶æ€ | æ“ä½œ |
|---------|---------|---------|------|
| Waiting | ç©å®¶æ•° >= 2 ä¸”æœ‰äººå¼€å§‹æ¸¸æˆ | PreFlop | å‘æ‰‹ç‰Œ,æ”¶ç›²æ³¨ |
| PreFlop | æ‰€æœ‰ç©å®¶å®Œæˆä¸‹æ³¨ | Flop | å‘3å¼ å…¬å…±ç‰Œ |
| Flop | æ‰€æœ‰ç©å®¶å®Œæˆä¸‹æ³¨ | Turn | å‘1å¼ å…¬å…±ç‰Œ |
| Turn | æ‰€æœ‰ç©å®¶å®Œæˆä¸‹æ³¨ | River | å‘1å¼ å…¬å…±ç‰Œ |
| River | æ‰€æœ‰ç©å®¶å®Œæˆä¸‹æ³¨ | Showdown | è¯·æ±‚è§£å¯† |
| Showdown | è§£å¯†å®Œæˆ | Finished | æ¯”ç‰Œ,åˆ†é…å¥–æ±  |
| Finished | æ¸…ç†å®Œæˆ | Waiting | é‡ç½®æ¸¸æˆæ¡Œ |

### 4.3 ç‰¹æ®Šæƒ…å†µå¤„ç†

- **åªå‰©ä¸€äºº**: ä»»ä½•é˜¶æ®µå¦‚æœåªå‰©ä¸€ä¸ªæ´»è·ƒç©å®¶,ç›´æ¥è¿›å…¥FinishedçŠ¶æ€
- **è¶…æ—¶**: ç©å®¶è¶…æ—¶æœªè¡ŒåŠ¨,è‡ªåŠ¨Fold
- **å…¨ä¸‹(All-In)**: ç©å®¶å…¨ä¸‹åè‡ªåŠ¨è·³è¿‡åç»­ä¸‹æ³¨è½®

## 5. ä¸‹æ³¨é€»è¾‘è®¾è®¡

### 5.1 ç©å®¶åŠ¨ä½œ

```solidity
enum PlayerAction {
    None,   // æ— åŠ¨ä½œ
    Fold,   // å¼ƒç‰Œ - é€€å‡ºæœ¬å±€
    Check,  // è¿‡ç‰Œ - å½“å‰æ— éœ€è·Ÿæ³¨æ—¶å¯ç”¨
    Call,   // è·Ÿæ³¨ - è·Ÿä¸Šå½“å‰æœ€é«˜æ³¨
    Raise,  // åŠ æ³¨ - æé«˜ä¸‹æ³¨é‡‘é¢
    AllIn   // å…¨ä¸‹ - ä¸‹æ³¨æ‰€æœ‰ç­¹ç 
}
```

### 5.2 ä¸‹æ³¨è§„åˆ™

1. **ç›²æ³¨é˜¶æ®µ** (PreFlopå¼€å§‹å‰):
   - å°ç›²ä½è‡ªåŠ¨ä¸‹å°ç›²æ³¨
   - å¤§ç›²ä½è‡ªåŠ¨ä¸‹å¤§ç›²æ³¨
   - ä»å¤§ç›²ä½ä¸‹å®¶å¼€å§‹è¡ŒåŠ¨

2. **ä¸‹æ³¨è½®æ¬¡**:
   - æ¯è½®ä»åº„å®¶ä¸‹å®¶å¼€å§‹(Flop/Turn/River)
   - æŒ‰é¡ºæ—¶é’ˆæ–¹å‘è½®æµè¡ŒåŠ¨
   - å½“æ‰€æœ‰ç©å®¶ä¸‹æ³¨ç›¸ç­‰æ—¶,æœ¬è½®ç»“æŸ

3. **åŠ¨ä½œé™åˆ¶**:
   - Fold: ä»»ä½•æ—¶å€™å¯ç”¨
   - Check: ä»…å½“ `currentBet == playerBet` æ—¶å¯ç”¨
   - Call: ä»…å½“ `currentBet > playerBet` æ—¶å¯ç”¨
   - Raise: å¿…é¡»è‡³å°‘æ˜¯å½“å‰æœ€é«˜æ³¨çš„2å€
   - AllIn: ä»»ä½•æ—¶å€™å¯ç”¨

### 5.3 å¥–æ± è®¡ç®—

```solidity
// æ¯æ¬¡ä¸‹æ³¨åæ›´æ–°å¥–æ± 
pot = FHE.add(pot, betAmount);

// è¾¹æ± å¤„ç†(ç®€åŒ–ç‰ˆæœ¬æš‚ä¸å®ç°)
// å½“æœ‰ç©å®¶AllInæ—¶,éœ€è¦è®¡ç®—ä¸»æ± å’Œè¾¹æ± 
```

## 6. å‘ç‰Œé€»è¾‘è®¾è®¡

### 6.1 éšæœºæ•°ç”Ÿæˆ

```solidity
// ä½¿ç”¨FHEVMçš„éšæœºæ•°ç”Ÿæˆ
euint8 randomCard = FHE.randEuint8();

// é™åˆ¶èŒƒå›´åˆ°0-51
euint8 card = FHE.rem(randomCard, 52);
```

### 6.2 é˜²é‡å¤æœºåˆ¶

```solidity
// æ–¹æ¡ˆ1: ä½¿ç”¨å·²å‘ç‰Œæ ‡è®°æ•°ç»„
bool[52] dealtCards;

// æ–¹æ¡ˆ2: é‡æ–°ç”Ÿæˆç›´åˆ°ä¸é‡å¤(gasæ¶ˆè€—è¾ƒé«˜)
while (isDuplicate(card)) {
    card = FHE.randEuint8();
}
```

### 6.3 å‘ç‰Œæµç¨‹

1. **PreFlop**: ç»™æ¯ä½ç©å®¶å‘2å¼ åŠ å¯†æ‰‹ç‰Œ
2. **Flop**: å‘3å¼ æ˜æ–‡å…¬å…±ç‰Œ
3. **Turn**: å‘1å¼ æ˜æ–‡å…¬å…±ç‰Œ
4. **River**: å‘1å¼ æ˜æ–‡å…¬å…±ç‰Œ

### 6.4 ACLæƒé™è®¾ç½®

```solidity
// ç©å®¶æ‰‹ç‰Œåªå…è®¸ç©å®¶è‡ªå·±å’Œåˆçº¦è®¿é—®
FHE.allowThis(player.card1);
FHE.allow(player.card1, player.addr);

FHE.allowThis(player.card2);
FHE.allow(player.card2, player.addr);
```

## 7. æ¯”ç‰Œé€»è¾‘è®¾è®¡

### 7.1 ç‰Œå‹ç­‰çº§

```solidity
enum HandRank {
    HighCard,       // 0 - é«˜ç‰Œ
    OnePair,        // 1 - ä¸€å¯¹
    TwoPair,        // 2 - ä¸¤å¯¹
    ThreeOfKind,    // 3 - ä¸‰æ¡
    Straight,       // 4 - é¡ºå­
    Flush,          // 5 - åŒèŠ±
    FullHouse,      // 6 - è‘«èŠ¦
    FourOfKind,     // 7 - å››æ¡
    StraightFlush,  // 8 - åŒèŠ±é¡º
    RoyalFlush      // 9 - çš‡å®¶åŒèŠ±é¡º
}
```

### 7.2 ç‰Œå‹è¯„ä¼°

```solidity
function evaluateHand(
    euint8 card1,
    euint8 card2,
    uint8[5] memory community
) internal returns (HandEvaluation memory) {
    // 1. ç»„åˆ7å¼ ç‰Œ(2æ‰‹ç‰Œ + 5å…¬å…±ç‰Œ)
    // 2. æ£€æµ‹ç‰Œå‹(ä»é«˜åˆ°ä½)
    // 3. è¿”å›ç‰Œå‹ç­‰çº§å’Œè¸¢è„šç‰Œ
}
```

### 7.3 æ¯”ç‰Œæµç¨‹

```solidity
// 1. è¯·æ±‚è§£å¯†æ‰€æœ‰ç©å®¶æ‰‹ç‰Œ
function requestShowdown(uint256 tableId) external {
    bytes32[] memory cts = new bytes32[](activePlayers * 2);
    // æ”¶é›†æ‰€æœ‰æ´»è·ƒç©å®¶çš„æ‰‹ç‰Œ
    uint256 requestId = FHE.requestDecryption(cts, this.callbackShowdown.selector);
}

// 2. è§£å¯†å›è°ƒ
function callbackShowdown(
    uint256 requestId,
    bytes memory decrypted,
    bytes memory proof
) external {
    FHE.checkSignatures(requestId, decrypted, proof);
    // è§£å¯†æ‰‹ç‰Œ,è¯„ä¼°ç‰Œå‹,ç¡®å®šè·èƒœè€…
}
```

## 8. å®‰å…¨è€ƒè™‘

### 8.1 é˜²æ­¢ä¿¡æ¯æ³„éœ²

- âœ… æ‰‹ç‰Œå®Œå…¨åŠ å¯†,ç©å®¶æ— æ³•çœ‹åˆ°ä»–äººæ‰‹ç‰Œ
- âœ… ä¸‹æ³¨é‡‘é¢å¯é€‰åŠ å¯†(å¢åŠ ç­–ç•¥æ€§)
- âœ… ä½¿ç”¨ACLä¸¥æ ¼æ§åˆ¶è®¿é—®æƒé™

### 8.2 é˜²æ­¢ä½œå¼Š

- âœ… é“¾ä¸Šéšæœºæ•°,æ— æ³•é¢„æµ‹
- âœ… å‘ç‰Œå³åŠ å¯†,æ— æ³•æå‰çŸ¥é“
- âœ… è§£å¯†éœ€è¦KMSç­¾åéªŒè¯

### 8.3 é˜²æ­¢é‡æ”¾æ”»å‡»

- âœ… ä½¿ç”¨requestIdéªŒè¯è§£å¯†ç»“æœ
- âœ… æ¯æ¬¡è§£å¯†åæ›´æ–°çŠ¶æ€,é˜²æ­¢é‡å¤ä½¿ç”¨

### 8.4 è¶…æ—¶ä¿æŠ¤

- âœ… è®¾ç½®è¡ŒåŠ¨è¶…æ—¶æ—¶é—´(60ç§’)
- âœ… è¶…æ—¶è‡ªåŠ¨Fold,é˜²æ­¢æ‹–å»¶

## 9. Gasä¼˜åŒ–

### 9.1 æ•°æ®ç»“æ„ä¼˜åŒ–

- ä½¿ç”¨å›ºå®šå¤§å°æ•°ç»„è€ŒéåŠ¨æ€æ•°ç»„
- åˆç†ä½¿ç”¨ `uint8` è€Œé `uint256`
- æ‰¹é‡å¤„ç†å‡å°‘å­˜å‚¨æ“ä½œ

### 9.2 FHEæ“ä½œä¼˜åŒ–

- ä¼˜å…ˆä½¿ç”¨æ ‡é‡æ“ä½œ(scalar operands)
- é¿å…ä¸å¿…è¦çš„ç±»å‹è½¬æ¢
- åˆç†ä½¿ç”¨ `FHE.select` å‡å°‘åˆ†æ”¯

### 9.3 HCUé™åˆ¶

- å•ç¬”äº¤æ˜“HCUé™åˆ¶: 20,000,000
- æ·±åº¦é™åˆ¶: 5,000,000
- éœ€è¦åˆç†æ‹†åˆ†å¤æ‚æ“ä½œ

## 10. æœªæ¥æ‰©å±•

### 10.1 MVPç‰ˆæœ¬(å½“å‰)

- âœ… 2-6äººå¾·å·æ‰‘å…‹
- âœ… åŸºç¡€ä¸‹æ³¨æ“ä½œ
- âœ… æ‰‹ç‰ŒåŠ å¯†
- âœ… è‡ªåŠ¨æ¯”ç‰Œç»“ç®—

### 10.2 V2ç‰ˆæœ¬

- [ ] å¤šæ¡Œå¹¶è¡Œ
- [ ] è¾¹æ± (Side Pot)å¤„ç†
- [ ] æ—è§‚è€…æ¨¡å¼
- [ ] èŠå¤©åŠŸèƒ½

### 10.3 V3ç‰ˆæœ¬

- [ ] é”¦æ ‡èµ›æ¨¡å¼
- [ ] æ’è¡Œæ¦œç³»ç»Ÿ
- [ ] NFTå¥–åŠ±
- [ ] DAOæ²»ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-20  
**ä½œè€…**: FHE Poker Team
